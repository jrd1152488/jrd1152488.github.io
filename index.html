<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.css">
  <style>
    #map {
      bottom: 0;
      left: 0;
      position: absolute;
      right: 0;
      top: 0;
      z-index: 8;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://unpkg.com/georaster"></script>
  <script src="https://unpkg.com/proj4"></script>
  <script src="https://unpkg.com/georaster-layer-for-leaflet"></script>
  <script src="https://unpkg.com/browse/georaster-layer-for-leaflet@0.4.1/georaster-layer-for-leaflet.browserify.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.js"></script>
  <script>
    // initalize leaflet map
    var map = L.map('map').setView([13.0, 122.0], 6); // Centered on the Philippines

    // add OpenStreetMap basemap
    L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // add easybutton to the map for uploading GeoTIFF
    L.easyButton('fa-upload', function(btn, map){
      // create a file input element
      var input = document.createElement('input');
      input.type = 'file';
      input.accept = '.tif,.tiff';

      // trigger the file input element when the button is clicked
      input.onchange = function(event) {
        var file = event.target.files[0];
        console.log("file:", file);

        var reader = new FileReader();
        reader.readAsArrayBuffer(file);
        reader.onloadend = function() {
          var arrayBuffer = reader.result;
          parseGeoraster(arrayBuffer).then(georaster => {

            console.log("georaster:", georaster);
            var layer = new GeoRasterLayer({
                georaster: georaster,
                opacity: 0.7,
                resolution: 256
            });
            console.log("layer:", layer);
            layer.addTo(map);

            map.fitBounds(layer.getBounds());
          });
        };
      };
      input.click();
    }).addTo(map);

    // add easybutton to the map for uploading GeoJSON, KMZ, or KML
    L.easyButton('fa-upload', function(btn, map){
      // create a file input element
      var input = document.createElement('input');
      input.type = 'file';
      input.accept = '.geojson,.kmz,.kml';

      // trigger the file input element when the button is clicked
      input.onchange = function(event) {
        var file = event.target.files[0];
        console.log("file:", file);

        var reader = new FileReader();
        reader.onloadend = function() {
          var content = reader.result;
          var layer = null;

          // handle different file formats
          if (file.name.endsWith('.geojson')) {
            layer = L.geoJSON(JSON.parse(content));
          } else if (file.name.endsWith('.kmz') || file.name.endsWith('.kml')) {
            layer = geoblaze.georasterToCanvas(content);
          }

          if (layer) {
            layer.addTo(map);
            map.fitBounds(layer.getBounds());
          } else {
            console.log('Invalid file format. Please upload a GeoJSON, KMZ, or KML file.');
          }
        };
        reader.readAsText(file);
      };
      input.click();
    }).addTo(map);
  </script>
</body>
</html>
